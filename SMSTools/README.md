## SMS Tools

This directory stores some useful tools for Android SMS. 

The Python script ``rearranger.py`` is used for rearranging the ID field of SMS structures. 

For other information, we only offer the Chinese language since those issues will only happen in China, where every manufacturer highly customizes its device, far away from AOSP. 

---

## SMS 工具

此目录存储了一些用于 Android 短信的实用工具。

国内的安卓生态体系被各大手机厂商高度定制化，导致用户在从由某一个厂商生产的旧手机换到由另一个厂商生产的新手机时难以将短信（SMS）高效地进行转移。

我们在此处提供一些思路，并提供一些有关的工具，其中，Python 脚本 ``rearrange.py`` 可用于重新排列短信结构体中的 ID。

### 旧手机数据可用

在这种情况下，直接使用 [https://github.com/tmo1/sms-ie](https://github.com/tmo1/sms-ie) 工具从旧手机导出短信，将备份文件转移至新手机，并继续使用该工具将备份文件中的短信导入到新手机即可。

导出和导入过程均不需要使用 root 权限，导入过程需要将该工具临时设为默认短信应用，在导入完成后谨记将默认短信应用换回原默认短信应用，否则将可能导致发来的短信延误甚至丢失。

当然，也可以使用 Swift Backup 一类的备份还原工具对短信进行本地备份后将旧手机的本地短信备份数据迁移到新手机，再使用同一备份还原工具从迁移所得的本地短信备份数据中将短信数据还原到新手机上；
也可以将旧手机的短信数据通过此类备份还原工具备份到云端，再在新手机上使用同一备份还原工具从云端将短信数据还原到新手机上；一般情况下，此类备份还原工具所需要的权限与上述权限类似。

请注意，为了确保数据完整性，建议在确定执行数据迁移时再执行备份与还原，或在确定执行数据迁移时检查并更新以前的备份数据，使得迁移到新手机的数据尽可能完整。

### 旧手机数据不可用

有时，由于手机丢失或手机出现了硬件级或需要清除数据来挽救的软件级故障，旧手机所有数据丢失，此时，如果旧手机有储存于云端的担心数据备份，则可以从云端恢复短信数据。

那么问题来了，如果使用的是类似于 Swift Backup 的云备份工具，那么还原短信将会十分容易，不需要 root，只需临时将 Swift Backup 一类的工具临时设置为默认短信应用导入后还原默认短信应用即可。

然而，如果使用的是一加云备份、OPPO 云服务、小米云服务等厂商高度定制化的云端备份服务，那就要分情况考虑了。

如果新旧手机源于同一厂商且使用同一账号框架（旧手机一加国行新手机一加国际版则可能导致账号不通用），那直接从厂商的云端把短信数据恢复回来即可。

但笔者相信存在部分用户会出现从由某一个厂商生产的旧手机换到由另一个厂商生产的新手机的情况，因为笔者就出现了这种情况。

如果说旧手机还可以使用，可以重新登录旧手机所属厂商的用户账号，随后从云端直接恢复短信数据到旧手机上，再使用上文所述的方法进行转移即可。

然而，如果旧手机是丢失了或者是无法使用了，那不太可能再去买（如果是这样那为什么还要买由另一个厂商出厂的手机）或者借用一台与旧手机同属于一个厂商的手机来先恢复到这台手机上再迁移到新手机上。
于是，当笔者兴致勃勃地在相应网页打开短信后，发现绝大多数厂家的云端备份服务仅提供浏览和删除短信的操作，只有一加云备份提供了下载按钮，但下载下来的是 ``.csv`` 文件，
目前绝大多数的手机自带的短信应用都不支持对 ``.csv`` 格式的短信备份文件进行导入，且似乎也没有第三方工具支持对 ``.csv`` 格式的短信备份进行导入；而且，总不能为了因此，只能尝试曲线救国。

1) 登录相应厂商的云端备份服务网页，找到短信数据，浏览，随后使用“Ctrl + S”或爬虫将每一个对话下载下来，保存为 ``.html`` 格式，利用 F12 定位关键 ``div`` 的 ``class``。
2) 编写 Python 脚本，利用美丽的汤（``from bs4 import BeautifulSoup``）将每一个会话中的联系人号码（``address``）、收发短信的时间（``date`` 和 ``date_sent``）和内容（``body``）提取出来。
3) 在新手机上随便发送和接收一条短信（例如可以接收一条验证码），使用 [https://github.com/tmo1/sms-ie](https://github.com/tmo1/sms-ie) 工具导出短信为 ``samples.zip``，解压获得 ``messages.ndjson``。
4) 将提取到的每一条短信按照以下规则转换为一个字典，随后将这些字典连同上述 ``messages.json`` 送入 DeepSeek，用深度思考模式将这些字典转为 ``ndjson`` 格式。
5) 下载 DeepSeek 输出的 ``.ndjson`` 文件，检查，包括但不限于确保短信完整性、数据结构、每一个字典以字符串的形式在 ``messages.ndjson`` 中独占一行，确认无误后，将此文件重命名为 ``messages.ndjson``。
6) 使用压缩工具（如 7z）将新的 ``messages.ndjson`` 打包为压缩包后传输到新手机，在新手机上使用 [https://github.com/tmo1/sms-ie](https://github.com/tmo1/sms-ie) 工具完成导入即可。

| 字段名 | 示例 | 要求（字段的值均为字符串） |
| - | - | - |
| ``_id`` | ``"_id":"2000"`` | 一条短信独占一个 ``_id`` 值 |
| ``thread_id`` | ``"thread_id":"1"`` | 同一号码（``address``）共享同一个 ``thread_id`` 值且不同号码的 ``thread_id`` 值不同 |
| ``address`` | ``"address":"10000" | 电话号码 |
| ``date`` | ``"date":"1554565320000"`` | 时间戳形式的发送时间 |
| ``date_sent`` | ``"date_sent":"1554565320000"`` | 时间戳形式的送达时间（可与发送时间相同） |
| ``protocol `` | ``"protocol":"0" `` | 协议（照抄即可） |
| ``read`` | ``"read":"1"`` | 已读状态（``1`` 代表已读、``0`` 代表未读、照抄即可） |
| ``status`` | ``"status":"-1"`` | 状态（照抄即可）|
| ``type`` | ``"type":"1"`` | 类型（``1`` 代表接收、``2`` 代表发送） |
| ``reply_path_present`` | ``"reply_path_present":"0"`` | 照抄即可 |
| ``body`` | ``"body":"【小米】9429（注册小米帐号验证码，注册后将绑定此安全手机）" | 短信内容 |
| ``service_center`` | ``"service_center":"+460030934260200"`` | 服务中心（可能是基站，一般照抄，也可以让 DeepSeek 补全） |
| ``locked`` | ``"locked":"0"`` | 指示短信是否被锁定（``1`` 代表已锁定、``0`` 代表未锁定、照抄即可） |
| ``sub_id`` | ``"sub_id":"3"`` | 子 ID（通常为从 1 开始的同一个号码中的第几条短信） |
| ``phone_id | |"phone_id":"-1" | 设备 ID（照抄即可） |
| ``error_code`` | ``"error_code":"-1"`` | 错误代码（照抄即可） |
| ``creator`` | ``"creator":"com.google.android.apps.messaging"`` | 收到新短信后处理该短信的应用程序的包名（照抄并使用谷歌短信应用的包名即可） |
| ``seen`` | ``"seen":"1"`` | 是否可见（``1`` 代表可见、``0`` 代表不可见、照抄即可） |
| ``priority`` | ``"priority":"-1"`` | 优先级（照抄即可） |
| ``style_code`` | ``"style_code":"0"`` | 风格代码（照抄即可） |
| ``combine_id`` | ``"combine_id":"0"`` | 照抄即可 |
| ``deleted`` | ``"deleted":"0"`` | 是否已删除（``1`` 代表已删除、``0`` 代表未删除、照抄即可）
| ``m_id`` | "m_id":"-1" | 照抄即可 |


此处提供了一个名为 ``fetchMsgs.py`` 的 Python 脚本，可在将小米云服务的短信页面保存为与该脚本处于同一目录的 ``.html`` 文件后执行该脚本以实现转换，目前已知的局限性有两点，
一是仅支持文字，不支持彩信，也不支持短信中的表情符号；二是受云端备份服务的限制，时间精度可能只能精确到分钟，Python ``datetime.datetime.timestamp`` 转换的结果将会一致，
而一分钟内可能会出现多条短信，造成顺序错乱，目前此脚本检测到多条短信位于同一分钟内时则自动将每一封该分钟内的短信较其同一分钟内的前一份短信默认增加十秒以确保顺序正确，
请用户根据消息数量将 ``offset`` 设置为一毫秒到三十秒的闭区间内的一个整数，即 ``offset`` 应当为位于 $[0, 30000]$ 内的一个整数值，
但如果一分钟内短信的数量超过 60000 条，即使 ``offset = 1``，也可能会导致从该分钟内的第 60001 条开始的短信出现在下一分钟上导致时间错误。

对于导入后表情符号未能在手机端正确显示的短信，可以先将所有短信导出，随后单独保留此类短信，利用个人电脑或手机的文本编辑工具编辑 ``messages.ndjson``，将未能正确显示的表情符号修正。
在修正表情符号时，可以先尝试利用 F12 直接从网页源代码将表情符号进行复制，随后到文本编辑工具中的相应位置进行粘贴，如在粘贴后仍未能正常显示，
则尝试直接在文本编辑工具中使用中文输入法打出相应表情符号的名称的拼音，在候选项约 5 或 6 的位置确认表情符号后选择对应的候选项进行键入，
或尝试在文本编辑工具中使用中文输入法打出相应表情符号的粗略名称的拼音（例如“笑”），随后打开输入法的表情符号面板进行选择，直至未能正确显示的表情符号得到修正。

愿所有应当永恒的数据都能永恒，愿世间不再有不期望的数据流失！
